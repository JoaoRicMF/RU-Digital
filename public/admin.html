<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RU Digital — Painel Administrativo</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <link rel="stylesheet" href="Css/style.css">
    <script>
    // Usa document.documentElement para evitar o erro de 'null' no body
        if (localStorage.getItem('ru_theme') === 'dark') {
            document.documentElement.classList.add('dark-mode');
        }

        // Garante que a classe seja aplicada ao body assim que ele estiver disponível
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('ru_theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
        });
    </script>
    <style>
        /* ==================== ESTILOS COMPLEMENTARES (ADMIN) ==================== */
        /* Tabelas */
        .table-wrap { overflow-x: auto; width: 100%; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; text-align: left; background: #fff; }
        th { padding: 14px 16px; border-bottom: 2px solid #eee; color: var(--text-light); font-weight: 700; text-transform: uppercase; font-size: 0.8rem; background: #fdfdfd; }
        td { padding: 14px 16px; border-bottom: 1px solid #eee; color: var(--text-dark); vertical-align: middle; }
        tr:hover td { background-color: rgba(46, 125, 117, 0.03); }

        /* Badges */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
        .badge-admin    { background: rgba(240, 110, 62, 0.15); color: var(--accent-color); }
        .badge-student  { background: rgba(46, 125, 117, 0.15); color: var(--primary-color); }
        .badge-active   { background: #dcfce7; color: #15803d; }
        .badge-inactive { background: #fee2e2; color: #b91c1c; }
        .badge-almoco   { background: #fef3c7; color: #92400e; }
        .badge-jantar   { background: #e0f2fe; color: #0369a1; }

        /* Dashboard Cards */
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px; }
        .stat-card { background: #f9fafb; border: 1px solid #eee; border-radius: 12px; padding: 24px; text-align: center; transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .stat-value { font-size: 2.2rem; font-weight: 800; color: var(--primary-color); line-height: 1; }
        .stat-label { font-size: 0.9rem; color: var(--text-light); margin-top: 8px; font-weight: 500; }

        /* Controles, Botões e Filtros */
        .filter-bar { display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px; }
        .btn-sm { padding: 8px 14px; font-size: 0.85rem; height: auto; border-radius: 8px; max-width: fit-content;}
        .btn-group { display: flex; gap: 8px; }
        .btn-danger { background-color: #E53935; color: white; border: none;}
        .btn-danger:hover { background-color: #c62828; }

        /* Paginação */
        .pagination { display: flex; gap: 6px; justify-content: center; margin-top: 20px; }
        .page-btn { padding: 6px 12px; border: 1px solid #e0e0e0; background: #fff; border-radius: 8px; cursor: pointer; font-weight: 600; color: var(--text-dark); transition: all 0.2s; }
        .page-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .page-btn:hover:not(.active) { background: #f1f1f1; }

        /* Toast Notifications */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--text-dark); color: #fff; padding: 14px 20px; border-radius: 10px; font-size: 0.95rem; font-weight: 500; box-shadow: 0 6px 16px rgba(0,0,0,0.15); animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-width: 350px;}
        .toast.success { background: var(--primary-color); }
        .toast.error   { background: #E53935; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Edição de Itens de Cardápio */
        #itens-container { background: #f9fafb; padding: 16px; border-radius: 12px; border: 1px dashed #cfd8dc; margin-bottom: 20px;}
        .item-row { display: grid; grid-template-columns: 2fr 3fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
        .item-header { font-size: 0.8rem; color: var(--text-light); font-weight: 700; margin-bottom: 8px; text-transform: uppercase;}
        .btn-remove-item { background: transparent; color: #E53935; border: 1px solid rgba(229, 57, 53, 0.3); border-radius: 8px; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-remove-item:hover { background: rgba(229, 57, 53, 0.1); border-color: #E53935; }
        
        .modal-content.large { max-width: 700px; } /* Modal maior para cardápio */

        @media (max-width: 768px) {
            .item-row { grid-template-columns: 1fr 1fr; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
            .item-header { display: none; }
            /* ==================== DARK MODE ADMIN ==================== */
            body.dark-mode table { background: var(--card-bg); }
            body.dark-mode th { background: #161b22; border-color: var(--border-color); color: var(--text-light); }
            body.dark-mode td { border-color: var(--border-color); color: var(--text-dark); }
            body.dark-mode tr:hover td { background-color: rgba(46, 125, 117, 0.15); }
            body.dark-mode .table-wrap { border-color: var(--border-color); }
            body.dark-mode .stat-card { background: #161b22; border-color: var(--border-color); }
            body.dark-mode .page-btn { background: #161b22; border-color: var(--border-color); color: var(--text-dark); }
            body.dark-mode .page-btn:hover:not(.active) { background: #30363d; }
            body.dark-mode #itens-container { background: #161b22; border-color: var(--border-color); }
            body.dark-mode .item-row { border-color: var(--border-color); }
            body.dark-mode .toast { background: #21262d; border: 1px solid var(--border-color); color: var(--text-dark); }
            body.dark-mode .toast.success { background: var(--primary-color); color: #fff; }
            body.dark-mode .toast.error { background: #E53935; color: #fff; }
        }
        body.dark-mode .stat-card,
        body.dark-mode .form-input,
        body.dark-mode table,
        body.dark-mode .table-wrap {
            background-color: var(--card-bg) !important; /* Força o fundo escuro do card */
            color: var(--text-dark) !important;
            border-color: var(--border-color) !important;
        }

        /* Ajusta o fundo específico dos inputs de data e texto nos filtros */
        body.dark-mode .filter-bar input,
        body.dark-mode .filter-bar select {
            background-color: #161b22 !important; /* Tom um pouco mais escuro para destaque */
            color: white !important;
        }

        /* Resolve o fundo branco do cabeçalho da tabela */
        body.dark-mode th {
            background-color: #0d1117 !important;
            color: var(--text-light) !important;
            border-bottom: 2px solid var(--border-color) !important;
        }

        /* Ajusta o hover das linhas da tabela */
        body.dark-mode tr:hover td {
            background-color: rgba(46, 125, 117, 0.1) !important;
        }

        /* Inverte a cor do ícone de calendário nos inputs de data */
        body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="app-container">

    <section id="admin-login" class="login-container">
        <div class="login-box-modern">
            <img src="assets/img/OIP.webp" alt="Logo UFCAT" class="login-img">
            <h1 class="login-title">Administração RU</h1>
            
            <div class="login-input-wrapper">
                <i class="fa-solid fa-envelope"></i>
                <input type="email" id="login-email" class="login-input-modern" placeholder="admin@ufcat.edu.br" autocomplete="username">
            </div>
            
            <div class="login-input-wrapper">
                <i class="fa-solid fa-lock"></i>
                <input type="password" id="login-password" class="login-input-modern" placeholder="••••••••" autocomplete="current-password">
            </div>
            
            <p id="login-error" class="error-text-dark mt-8 d-none">Credenciais inválidas.</p>
            
            <button id="btn-admin-login" class="btn-login-modern mt-16">Entrar no Painel</button>
            
            <div class="login-links">
                <div class="login-divider"></div>
                <a href="index.html" class="btn-admin-modern">
                    <i class="fa-solid fa-arrow-left"></i> Voltar para o Estudante
                </a>
            </div>
        </div>
        <p class="login-footer-text">© 2026 UFCAT — Painel Restrito</p>
    </section>

    <nav id="sidebar" class="bottom-nav d-none">
        <div class="sidebar-logo">
            <img src="assets/img/OIP.webp" alt="Logo UFCAT" class="sidebar-logo-img">
            <span class="sidebar-logo-title">Admin RU</span>
        </div>
        
        <div style="flex: 1; display: flex; flex-direction: column;">
            <div class="nav-item active" data-section="sec-dashboard">
                <div class="nav-icon-box"><i class="fa-solid fa-chart-pie"></i></div>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" data-section="sec-menu">
                <div class="nav-icon-box"><i class="fa-solid fa-utensils"></i></div>
                <span>Cardápio</span>
            </div>
            <div class="nav-item" data-section="sec-users">
                <div class="nav-icon-box"><i class="fa-solid fa-users"></i></div>
                <span>Utilizadores</span>
            </div>
            <div class="nav-item" data-section="sec-ratings">
                <div class="nav-icon-box"><i class="fa-solid fa-star"></i></div>
                <span>Avaliações</span>
            </div>
        </div>
        
        <div class="nav-item" id="btn-admin-theme" style="border-top: 1px solid var(--border-color, #eee);">
            <div class="nav-icon-box"><i class="fa-solid fa-moon" id="admin-theme-icon"></i></div>
            <span id="admin-theme-text">Modo Escuro</span>
        </div>
        
        <div class="sidebar-footer" style="cursor: pointer;" id="btn-admin-logout">
            <i class="fa-solid fa-shield-halved sidebar-user-icon" style="color: var(--accent-color);"></i>
            <div class="sidebar-user-info">
                <span class="sidebar-user-name" id="topbar-admin-name">Administrador</span>
                <span class="sidebar-user-role" style="color: var(--accent-color); font-weight: 700;">Encerrar Sessão</span>
            </div>
        </div>
    </nav>

    <main id="main-content" class="d-none">

        <section class="view active" id="sec-dashboard">
            <div class="card">
                <h2 class="card-title-lg">Resumo do Dia</h2>
                <div class="admin-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="dash-total-avaliacoes">—</div>
                        <div class="stat-label">Avaliações hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dash-media-geral">—</div>
                        <div class="stat-label">Média geral hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dash-cardapios-hoje">—</div>
                        <div class="stat-label">Refeições lançadas hoje</div>
                    </div>
                </div>
                <p class="mt-16" style="color:var(--text-light); font-size:0.9rem">Use a navegação para gerenciar o sistema de forma detalhada.</p>
            </div>
        </section>

        <section class="view" id="sec-menu">
            <div class="card">
                <h2 class="card-title-lg mb-16">Gestão de Cardápio</h2>

                <div class="filter-bar">
                    <div style="display: flex; flex-direction: column;">
                        <label class="balance-label">Data de Referência</label>
                        <input type="date" id="menu-filter-date" class="form-input" style="width: auto;" />
                    </div>
                    <button class="btn btn-outline btn-sm" id="btn-menu-search"><i class="fa-solid fa-magnifying-glass"></i> Buscar</button>
                    <button class="btn btn-primary btn-sm" id="btn-menu-new"><i class="fa-solid fa-plus"></i> Novo Cardápio</button>
                </div>

                <div class="table-wrap">
                    <table id="menu-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Refeição</th>
                                <th>Itens</th>
                                <th>Estado</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="menu-tbody">
                            <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">Selecione uma data e pesquise.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section class="view" id="sec-users">
            <div class="card">
                <h2 class="card-title-lg mb-16">Gestão de Utilizadores</h2>
                
                <div class="filter-bar">
                    <div style="display: flex; flex-direction: column; flex-grow: 1; max-width: 300px;">
                        <label class="balance-label">Pesquisar Utilizador</label>
                        <input type="text" id="user-search" class="form-input" placeholder="Nome ou e-mail..." />
                    </div>
                    <button class="btn btn-outline btn-sm" id="btn-user-search"><i class="fa-solid fa-magnifying-glass"></i> Pesquisar</button>
                </div>
                
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>E-mail</th>
                                <th>Curso</th>
                                <th>Perfil</th>
                                <th>Estado</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr><td colspan="6" style="text-align:center;color:var(--text-muted);padding:2rem">Clique em Pesquisar para carregar.</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="users-pagination"></div>
            </div>
        </section>

        <section class="view" id="sec-ratings">
            <div class="card">
                <h2 class="card-title-lg mb-16">Relatório de Avaliações</h2>
                
                <div class="filter-bar">
                    <div style="display: flex; flex-direction: column;">
                        <label class="balance-label">Data</label>
                        <input type="date" id="rating-filter-date" class="form-input" style="width: auto;" />
                    </div>
                    <div style="display: flex; flex-direction: column;">
                        <label class="balance-label">Refeição</label>
                        <select id="rating-filter-meal" class="form-input" style="width: auto;">
                            <option value="">Todas</option>
                            <option value="almoco">Almoço</option>
                            <option value="jantar">Jantar</option>
                        </select>
                    </div>
                    <button class="btn btn-outline btn-sm" id="btn-rating-search"><i class="fa-solid fa-magnifying-glass"></i> Buscar</button>
                </div>

                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Refeição</th>
                                <th>Total</th>
                                <th>Sabor</th>
                                <th>Temp.</th>
                                <th>Atend.</th>
                                <th>Limpeza</th>
                                <th>Geral</th>
                            </tr>
                        </thead>
                        <tbody id="ratings-tbody">
                            <tr><td colspan="8" style="text-align:center;color:var(--text-muted);padding:2rem">Selecione os filtros e pesquise.</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div id="comments-section" class="mt-20 d-none">
                    <h3 class="section-title mb-10">Comentários recentes</h3>
                    <div id="comments-list" style="display: flex; flex-direction: column; gap: 10px;"></div>
                </div>
            </div>
        </section>
    </main>
</div>

<div class="modal-overlay" id="menu-modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="menu-modal-title" style="color: var(--primary-color);">Novo Cardápio</h3>
            <button class="modal-close" id="close-menu-modal" style="background:none; border:none; font-size: 1.2rem; cursor: pointer; color: var(--text-light);"><i class="fa-solid fa-xmark"></i></button>
        </div>

        <input type="hidden" id="menu-edit-id" />

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;" class="mt-16">
            <div>
                <label class="balance-label">Data *</label>
                <input type="date" id="menu-data" class="form-input mt-8" required />
            </div>
            <div>
                <label class="balance-label">Refeição *</label>
                <select id="menu-refeicao" class="form-input mt-8">
                    <option value="almoco">Almoço</option>
                    <option value="jantar">Jantar</option>
                </select>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <label class="balance-label" style="font-weight: 700;">Itens do Cardápio *</label>
            <button class="btn btn-outline btn-sm" id="btn-add-item"><i class="fa-solid fa-plus"></i> Adicionar Item</button>
        </div>

        <div class="item-row item-header" style="margin-bottom: 0;">
            <span>Categoria</span>
            <span>Descrição</span>
            <span>Kcal</span>
            <span>Prot.(g)</span>
            <span>Carb.(g)</span>
            <span></span>
        </div>
        <div id="itens-container"></div>

        <div class="btn-group" style="justify-content:flex-end; margin-top:20px;">
            <button class="btn btn-outline btn-sm" id="btn-cancel-menu" style="max-width: 120px;">Cancelar</button>
            <button class="btn btn-primary btn-sm" id="btn-save-menu" style="max-width: 120px;"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="user-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="color: var(--primary-color);">Editar Utilizador</h3>
            <button class="modal-close" id="close-user-modal" style="background:none; border:none; font-size: 1.2rem; cursor: pointer; color: var(--text-light);"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <input type="hidden" id="user-edit-id" />
        
        <div class="mt-16 mb-16">
            <label class="balance-label">Nome</label>
            <input type="text" id="user-edit-name" class="form-input mt-8" disabled style="background:rgba(0,0,0,0.03);" />
        </div>
        
        <div class="mb-16">
            <label class="balance-label">Perfil</label>
            <select id="user-edit-tipo" class="form-input mt-8">
                <option value="estudante">Estudante</option>
                <option value="admin">Administrador</option>
            </select>
        </div>
        
        <div class="mb-16">
            <label class="balance-label">Estado da Conta</label>
            <select id="user-edit-ativo" class="form-input mt-8">
                <option value="1">Ativo</option>
                <option value="0">Bloqueado</option>
            </select>
        </div>
        
        <div class="btn-group" style="justify-content:flex-end; margin-top:20px;">
            <button class="btn btn-outline btn-sm" id="btn-cancel-user" style="max-width: 120px;">Cancelar</button>
            <button class="btn btn-primary btn-sm" id="btn-save-user" style="max-width: 120px;"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
        </div>
    </div>
</div>

<script>
// ================================================================
//  Lógica completa do painel administrativo
// ================================================================
(function () {
    const API_BASE = 'http://localhost:8000/api';

    // ── Utilitários ──────────────────────────────────────────────
    function token()  { return localStorage.getItem('ru_admin_token'); }
    function payload(){ 
        try { 
            const t = token(); if (!t) return null;
            return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); 
        } catch { return null; } 
    }

    async function apiFetch(endpoint, opts = {}) {
        const headers = { 'Content-Type': 'application/json', ...(token() ? { 'Authorization': `Bearer ${token()}` } : {}), ...(opts.headers ?? {}) };
        const res = await fetch(`${API_BASE}${endpoint}`, { ...opts, headers });
        const data = await res.json();
        if (!res.ok) throw new Error(data.mensagem ?? `Erro ${res.status}`);
        return data;
    }

    function toast(msg, type = '') {
        const el = document.createElement('div');
        el.className = 'toast ' + type;
        el.textContent = msg;
        document.getElementById('toast-container').appendChild(el);
        setTimeout(() => el.remove(), 3500);
    }

    function starsHtml(val) {
        if (val === null || val === undefined) return '<span style="color:var(--text-light)">—</span>';
        const full  = Math.round(val);
        let   stars = '';
        for (let i = 1; i <= 5; i++) stars += `<i class="fa-${i <= full ? 'solid' : 'regular'} fa-star"></i>`;
        return `<span style="color: var(--accent-color);">${stars}</span> <small style="color:var(--text-dark); font-weight: 600;">${Number(val).toFixed(1)}</small>`;
    }

    // ── Auth ─────────────────────────────────────────────────────
    function checkAuth() {
        const p = payload();
        if (!p || p.exp < Date.now() / 1000 || p.tipo !== 'admin') {
            document.getElementById('admin-login').classList.remove('d-none');
            document.getElementById('main-content').classList.add('d-none');
            document.getElementById('sidebar').classList.add('d-none');
            return false;
        }
        document.getElementById('admin-login').classList.add('d-none');
        document.getElementById('main-content').classList.remove('d-none');
        document.getElementById('sidebar').classList.remove('d-none');
        document.getElementById('topbar-admin-name').textContent = p.nome;
        return true;
    }

    document.getElementById('btn-admin-login').addEventListener('click', async function() {
        const email = document.getElementById('login-email').value.trim();
        const senha = document.getElementById('login-password').value;
        const errEl = document.getElementById('login-error');
        errEl.classList.add('d-none');

        if (!email || !senha) {
            errEl.textContent = 'Preencha o e-mail e a senha.';
            errEl.classList.remove('d-none');
            return;
        }

        const btn = this;
        btn.classList.add('is-loading');

        try {
            const resp = await apiFetch('/auth/login', { method: 'POST', body: JSON.stringify({ email, senha }) });
            const t    = resp.token ?? resp.data?.token;
            const p    = JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/')));

            if (p.tipo !== 'admin') {
                errEl.textContent = 'Acesso negado. Esta conta não é administradora.';
                errEl.classList.remove('d-none');
                return;
            }

            localStorage.setItem('ru_admin_token', t);
            if (checkAuth()) loadDashboard();

        } catch (err) {
            errEl.textContent = err.message || 'Erro ao conectar.';
            errEl.classList.remove('d-none');
        } finally {
            btn.classList.remove('is-loading');
        }
    });

    document.getElementById('btn-admin-logout').addEventListener('click', () => {
        localStorage.removeItem('ru_admin_token');
        checkAuth();
    });

    // ── Navegação ────────────────────────────────────────────────
    // ── Navegação ────────────────────────────────────────────────
    document.querySelectorAll('#sidebar .nav-item').forEach(link => {
        link.addEventListener('click', e => {
            // TRAVA DE SEGURANÇA: Se for o botão do modo escuro, cancela a navegação
            if (link.id === 'btn-admin-theme') return;

            e.preventDefault();
            document.querySelectorAll('#sidebar .nav-item').forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
            const sectionId = link.dataset.section;
            
            // Só tenta trocar de aba se existir um ID válido
            if (sectionId && document.getElementById(sectionId)) {
                document.querySelectorAll('.view').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
            }
        });
    });

    // ── Dashboard ────────────────────────────────────────────────
    async function loadDashboard() {
        const today = new Date().toISOString().split('T')[0];
        try {
            const [rat, men] = await Promise.all([
                apiFetch(`/admin/avaliacoes?data=${today}`),
                apiFetch(`/admin/cardapio?data=${today}`),
            ]);

            const resumo  = rat.data.resumo ?? [];
            const totalAv = resumo.reduce((s, r) => s + (r.total_avaliacoes || 0), 0);
            const medias  = resumo.filter(r => r.media_geral).map(r => parseFloat(r.media_geral));
            const mediaG  = medias.length ? (medias.reduce((a,b) => a+b) / medias.length).toFixed(1) : '—';

            document.getElementById('dash-total-avaliacoes').textContent = totalAv;
            document.getElementById('dash-media-geral').textContent      = mediaG;
            document.getElementById('dash-cardapios-hoje').textContent   = (men.data.cardapios ?? []).length;
        } catch { /* silencioso */ }
    }

    // ── Cardápio — Listagem ──────────────────────────────────────
    document.getElementById('menu-filter-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('btn-menu-search').addEventListener('click', loadMenuTable);

    async function loadMenuTable() {
        const date  = document.getElementById('menu-filter-date').value;
        const tbody = document.getElementById('menu-tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:1.5rem">Carregando…</td></tr>';
        try {
            const resp     = await apiFetch(`/admin/cardapio?data=${date}`);
            const cardapios = resp.data.cardapios ?? [];
            if (!cardapios.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-light);padding:1.5rem">Nenhum cardápio para esta data.</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            cardapios.forEach(c => {
                const refeicaoLabel = c.refeicao === 'almoco' ? 'Almoço' : 'Jantar';
                const badgeRef      = c.refeicao === 'almoco' ? 'badge-almoco' : 'badge-jantar';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:700;">#${c.id}</td>
                    <td>${c.data_ref.split('-').reverse().join('/')}</td>
                    <td><span class="badge ${badgeRef}">${refeicaoLabel}</span></td>
                    <td>${c.itens.length} item(ns)</td>
                    <td><span class="badge ${c.ativo ? 'badge-active' : 'badge-inactive'}">${c.ativo ? 'Ativo' : 'Inativo'}</span></td>
                    <td>
                        <div class="btn-group">
                            <button class="btn btn-outline btn-sm btn-edit-menu" data-id="${c.id}"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn btn-danger btn-sm btn-del-menu" data-id="${c.id}"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            window._menuData = cardapios;
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" style="color:#E53935;text-align:center;padding:1.5rem">${err.message}</td></tr>`;
        }
    }

    document.getElementById('menu-tbody').addEventListener('click', async e => {
        const editBtn = e.target.closest('.btn-edit-menu');
        const delBtn  = e.target.closest('.btn-del-menu');
        if (editBtn) openEditMenu(parseInt(editBtn.dataset.id));
        if (delBtn)  deleteMenu(parseInt(delBtn.dataset.id));
    });

    // ── Cardápio — Modal Criar / Editar ──────────────────────────
    const CATEGORIAS = ['principal','guarnicao','arroz_feijao','salada','sobremesa','suco','outro'];

    function buildItemRow(item = {}) {
        const row = document.createElement('div');
        row.className = 'item-row';
        const options = CATEGORIAS.map(c => `<option value="${c}" ${item.categoria===c?'selected':''}>${c}</option>`).join('');
        row.innerHTML = `
            <select class="form-input item-cat">${options}</select>
            <input  type="text"   class="form-input item-desc"  placeholder="Descrição *"     value="${item.descricao||''}" required />
            <input  type="number" class="form-input item-kcal"  placeholder="Cal."            value="${item.calorias||''}" min="0" />
            <input  type="number" class="form-input item-prot"  placeholder="Prot."           value="${item.proteinas_g||''}" step=".1" min="0" />
            <input  type="number" class="form-input item-carb"  placeholder="Carb."           value="${item.carboidratos_g||''}" step=".1" min="0" />
            <button type="button" class="btn-remove-item" title="Remover"><i class="fa-solid fa-trash-can"></i></button>
        `;
        row.querySelector('.btn-remove-item').addEventListener('click', () => row.remove());
        return row;
    }

    function openNewMenu() {
        document.getElementById('menu-modal-title').textContent = 'Novo Cardápio';
        document.getElementById('menu-edit-id').value    = '';
        document.getElementById('menu-data').value       = new Date().toISOString().split('T')[0];
        document.getElementById('menu-refeicao').value   = 'almoco';
        const cont = document.getElementById('itens-container');
        cont.innerHTML = '';
        ['principal','guarnicao','arroz_feijao','salada','sobremesa'].forEach(cat => {
            cont.appendChild(buildItemRow({ categoria: cat }));
        });
        document.getElementById('menu-modal').classList.add('open');
    }

    function openEditMenu(id) {
        const cardapio = (window._menuData || []).find(c => c.id === id);
        if (!cardapio) return;
        document.getElementById('menu-modal-title').textContent = `Editar Cardápio #${id}`;
        document.getElementById('menu-edit-id').value  = id;
        document.getElementById('menu-data').value     = cardapio.data_ref;
        document.getElementById('menu-refeicao').value = cardapio.refeicao;
        const cont = document.getElementById('itens-container');
        cont.innerHTML = '';
        cardapio.itens.forEach(item => cont.appendChild(buildItemRow(item)));
        document.getElementById('menu-modal').classList.add('open');
    }

    document.getElementById('btn-menu-new').addEventListener('click', openNewMenu);
    document.getElementById('btn-add-item').addEventListener('click', () => {
        document.getElementById('itens-container').appendChild(buildItemRow());
    });
    
    ['close-menu-modal', 'btn-cancel-menu'].forEach(id => {
        document.getElementById(id).addEventListener('click', () => document.getElementById('menu-modal').classList.remove('open'));
    });

    document.getElementById('btn-save-menu').addEventListener('click', async function() {
        const id       = document.getElementById('menu-edit-id').value;
        const dataRef  = document.getElementById('menu-data').value;
        const refeicao = document.getElementById('menu-refeicao').value;
        const rows     = document.getElementById('itens-container').querySelectorAll('.item-row');

        if (!dataRef) { toast('Selecione uma data.', 'error'); return; }
        if (!rows.length) { toast('Adicione pelo menos um item.', 'error'); return; }

        const itens = [];
        let valid = true;
        rows.forEach((row, i) => {
            const desc = row.querySelector('.item-desc').value.trim();
            if (!desc) { toast(`Item ${i+1}: descrição obrigatória.`, 'error'); valid = false; return; }
            itens.push({
                categoria:      row.querySelector('.item-cat').value,
                descricao:      desc,
                calorias:       row.querySelector('.item-kcal').value || null,
                proteinas_g:    row.querySelector('.item-prot').value || null,
                carboidratos_g: row.querySelector('.item-carb').value || null,
            });
        });
        if (!valid) return;

        this.classList.add('is-loading');
        try {
            const body = { data_ref: dataRef, refeicao, itens };
            if (id) {
                await apiFetch(`/admin/cardapio/${id}`, { method: 'PUT',  body: JSON.stringify(body) });
                toast('Cardápio atualizado!', 'success');
            } else {
                await apiFetch('/admin/cardapio',        { method: 'POST', body: JSON.stringify(body) });
                toast('Cardápio criado!', 'success');
            }
            document.getElementById('menu-modal').classList.remove('open');
            loadMenuTable();
        } catch (err) {
            toast(err.message, 'error');
        } finally {
            this.classList.remove('is-loading');
        }
    });

    async function deleteMenu(id) {
        if (!confirm(`Desativar o cardápio #${id}?`)) return;
        try {
            await apiFetch(`/admin/cardapio/${id}`, { method: 'DELETE' });
            toast('Cardápio desativado.', 'success');
            loadMenuTable();
        } catch (err) {
            toast(err.message, 'error');
        }
    }

    // ── Utilizadores ────────────────────────────────────────────
    let userPage = 1;

    document.getElementById('btn-user-search').addEventListener('click', () => { userPage = 1; loadUsers(); });
    document.getElementById('user-search').addEventListener('keydown', e => { if (e.key === 'Enter') { userPage = 1; loadUsers(); } });

    async function loadUsers() {
        const search = document.getElementById('user-search').value.trim();
        const tbody  = document.getElementById('users-tbody');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:1.5rem">Carregando…</td></tr>';
        try {
            const resp  = await apiFetch(`/admin/usuarios?page=${userPage}&limit=15&search=${encodeURIComponent(search)}`);
            const users = resp.data.usuarios ?? [];
            if (!users.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-light);padding:1.5rem">Nenhum utilizador encontrado.</td></tr>';
            } else {
                tbody.innerHTML = '';
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:600;">${u.nome}</td>
                        <td style="color:var(--text-light);font-size:.85rem">${u.email}</td>
                        <td style="font-size:.85rem">${u.curso ?? '—'}</td>
                        <td><span class="badge ${u.tipo==='admin'?'badge-admin':'badge-student'}">${u.tipo}</span></td>
                        <td><span class="badge ${u.ativo?'badge-active':'badge-inactive'}">${u.ativo?'Ativo':'Inativo'}</span></td>
                        <td><button class="btn btn-outline btn-sm btn-edit-user" data-id="${u.id}" data-nome="${u.nome}" data-tipo="${u.tipo}" data-ativo="${u.ativo}"><i class="fa-solid fa-pen"></i></button></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            renderUserPagination(resp.data.total, resp.data.limite);
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="6" style="color:#E53935;padding:1.5rem">${err.message}</td></tr>`;
        }
    }

    function renderUserPagination(total, limit) {
        const pages = Math.ceil(total / limit);
        const pg    = document.getElementById('users-pagination');
        pg.innerHTML = '';
        for (let i = 1; i <= pages; i++) {
            const btn = document.createElement('button');
            btn.className = 'page-btn' + (i === userPage ? ' active' : '');
            btn.textContent = i;
            btn.addEventListener('click', () => { userPage = i; loadUsers(); });
            pg.appendChild(btn);
        }
    }

    document.getElementById('users-tbody').addEventListener('click', e => {
        const btn = e.target.closest('.btn-edit-user');
        if (!btn) return;
        document.getElementById('user-edit-id').value    = btn.dataset.id;
        document.getElementById('user-edit-name').value  = btn.dataset.nome;
        document.getElementById('user-edit-tipo').value  = btn.dataset.tipo;
        document.getElementById('user-edit-ativo').value = btn.dataset.ativo;
        document.getElementById('user-modal').classList.add('open');
    });

    ['close-user-modal', 'btn-cancel-user'].forEach(id => {
        document.getElementById(id).addEventListener('click', () => document.getElementById('user-modal').classList.remove('open'));
    });

    document.getElementById('btn-save-user').addEventListener('click', async function() {
        const id    = document.getElementById('user-edit-id').value;
        const tipo  = document.getElementById('user-edit-tipo').value;
        const ativo = document.getElementById('user-edit-ativo').value;
        this.classList.add('is-loading');
        try {
            await apiFetch(`/admin/usuarios/${id}`, { method: 'PUT', body: JSON.stringify({ tipo, ativo: parseInt(ativo) }) });
            toast('Utilizador atualizado!', 'success');
            document.getElementById('user-modal').classList.remove('open');
            loadUsers();
        } catch (err) {
            toast(err.message, 'error');
        } finally {
            this.classList.remove('is-loading');
        }
    });

    // ── Avaliações ───────────────────────────────────────────────
    document.getElementById('rating-filter-date').value = new Date().toISOString().split('T')[0];
    document.getElementById('btn-rating-search').addEventListener('click', loadRatings);

    async function loadRatings() {
        const date    = document.getElementById('rating-filter-date').value;
        const meal    = document.getElementById('rating-filter-meal').value;
        const tbody   = document.getElementById('ratings-tbody');
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:1.5rem">Carregando…</td></tr>';
        try {
            let url = '/admin/avaliacoes';
            const params = [];
            if (date) params.push(`data=${date}`);
            if (meal) params.push(`refeicao=${meal}`);
            if (params.length) url += '?' + params.join('&');

            const resp    = await apiFetch(url);
            const resumo  = resp.data.resumo ?? [];
            const coments = resp.data.comentarios ?? [];

            if (!resumo.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text-light);padding:1.5rem">Sem avaliações para este filtro.</td></tr>';
            } else {
                tbody.innerHTML = '';
                resumo.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${r.data_ref.split('-').reverse().join('/')}</td>
                        <td><span class="badge ${r.refeicao==='almoco'?'badge-almoco':'badge-jantar'}">${r.refeicao==='almoco'?'Almoço':'Jantar'}</span></td>
                        <td><strong>${r.total_avaliacoes}</strong></td>
                        <td>${starsHtml(r.media_sabor)}</td>
                        <td>${starsHtml(r.media_temperatura)}</td>
                        <td>${starsHtml(r.media_atendimento)}</td>
                        <td>${starsHtml(r.media_limpeza)}</td>
                        <td>${starsHtml(r.media_geral)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }

            const sec = document.getElementById('comments-section');
            const lst = document.getElementById('comments-list');
            if (coments.length) {
                sec.classList.remove('d-none');
                lst.innerHTML = coments.map(c => `
                    <div style="background:#f9fafb; border:1px solid #eee; border-radius:12px; padding:16px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px; align-items:center;">
                            <strong style="color:var(--text-dark);">${c.autor}</strong>
                            <span style="color:var(--accent-color); font-size:0.9rem;">${'★'.repeat(c.nota_geral ?? 0)}</span>
                        </div>
                        <p style="color:var(--text-light); font-size:0.95rem;">"${c.comentario}"</p>
                    </div>
                `).join('');
            } else {
                sec.classList.add('d-none');
            }
        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="8" style="color:#E53935;padding:1.5rem">${err.message}</td></tr>`;
        }
    }

    // ── Fechar modais ao clicar no overlay ───────────────────────
    document.querySelectorAll('.modal-overlay').forEach(m => {
        m.addEventListener('click', e => { if (e.target === m) m.classList.remove('open'); });
    });

    // ── Enter no login ────────────────────────────────────────────
    document.getElementById('login-password').addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('btn-admin-login').click();
    });
    function applyAdminTheme(theme) {
        const isDark = theme === 'dark';
        document.body.classList.toggle('dark-mode', isDark);
        
        const icon = document.getElementById('admin-theme-icon');
        const text = document.getElementById('admin-theme-text');
        
        if (icon) icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        if (text) text.textContent = isDark ? 'Modo Claro' : 'Modo Escuro';
    }

    // Aplica o tema salvo ao carregar
    const currentTheme = localStorage.getItem('ru_theme') || 'light';
    applyAdminTheme(currentTheme);

    // Evento de clique
    const btnAdminTheme = document.getElementById('btn-admin-theme');
    if (btnAdminTheme) {
        btnAdminTheme.addEventListener('click', () => {
            const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
            localStorage.setItem('ru_theme', newTheme);
            applyAdminTheme(newTheme);
        });
    }

    // ── Init ─────────────────────────────────────────────────────
    if (checkAuth()) loadDashboard();
})();
</script>
</body>
</html>